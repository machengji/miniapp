# Aletheia 小程序部署指南

## 🔧 前置要求

1. **微信开发者工具** 最新版（建议 1.06+）
2. **小程序账号** 已注册
3. **云开发环境** 已开通（基础版即可）

---

## 步骤 1：创建云开发环境

### 1.1 开通云开发

```
微信开发者工具 → 点击 "云开发" 按钮（顶部工具栏）
→ 点击 "开通"
→ 选择 "基础版"（免费）
→ 记录环境ID（如：ai-2gps1hrk9062b64c）
```

### 1.2 配置环境ID

打开 `miniprogram/app.ts`，替换环境ID：

```typescript
wx.cloud.init({
  env: '你的环境ID',  // ← 替换这里
  traceUser: true,
});
```

---

## 步骤 2：创建数据库集合

### 2.1 创建 dreams 集合

```
1. 点击 "云开发" 按钮
2. 选择 "数据库" 标签
3. 点击 "+" 添加集合
4. 输入集合名称：dreams
5. 点击 "确定"
```

### 2.2 设置数据权限

```
点击 dreams 集合 → "数据权限" 标签
选择 "所有用户可读，仅创建者可读写"
或自定义：
```

```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

### 2.3 创建 users 集合（可选，用于用户档案）

```
1. 点击 "+" 添加集合
2. 输入集合名称：users
3. 设置相同权限
```

---

## 步骤 3：部署云函数

### 3.1 安装依赖并部署 saveDream

```
1. 右键点击 cloudfunctions/saveDream 文件夹
2. 选择 "在外部终端打开"（或直接用开发者工具）
3. 运行：npm install
4. 右键点击 saveDream 文件夹
5. 选择 "创建并部署：云端安装依赖"
```

### 3.2 验证部署

```
云开发控制台 → 云函数
应该能看到 saveDream 函数，状态为 "正常"
```

### 3.3 测试云函数

```
云开发控制台 → 云函数 → saveDream
→ 点击 "测试" 按钮
→ 使用以下测试参数：
```

```json
{
  "content": "测试梦境内容",
  "analysis": "<think>测试中</think>分析结果",
  "mood": "喜悦",
  "clarity": 4
}
```

**预期返回**：
```json
{
  "success": true,
  "id": "xxx",
  "summary": "测试之梦",
  "keywords": ["测试"]
}
```

---

## 步骤 4：开通 AI 扩展

### 4.1 安装 AI 扩展

```
云开发控制台 → 扩展功能
→ 搜索 "AI"
→ 点击 "安装"
→ 选择套餐：
   - 免费试用版：混元 100万次 + DeepSeek 10万次
   - 或按量付费版
```

### 4.2 等待开通

```
通常需要 1-5 分钟
开通后状态变为 "运行中"
```

---

## 步骤 5：编译运行

### 5.1 清理缓存

```
开发者工具 → 详情 → 本地设置
→ 勾选 "上传时进行代码压缩"
→ 点击 "刷新"
```

### 5.2 编译

```
点击 "编译" 按钮
或按 Ctrl+S
```

### 5.3 常见问题

#### 问题 1：基础库版本警告

```
错误：tagNameStyleIsolation 配置无效
```

**解决**：已在 app.json 中移除 skyline 配置，使用 webview 渲染。

#### 问题 2：数据库集合不存在

```
错误：[ResourceNotFound] Db or Table not exist: dreams
```

**解决**：按步骤 2.1 创建 dreams 集合。

#### 问题 3：云函数不存在

```
错误：FunctionName parameter could not be found
```

**解决**：按步骤 3 部署 saveDream 云函数。

#### 问题 4：AI 调用失败

```
错误：基础库版本过低
```

**解决**：
```
开发者工具 → 详情 → 本地设置
→ 调试基础库 → 选择 3.7.1 或更高版本
```

---

## 步骤 6：功能测试

### 6.1 测试聊天功能

```
1. 进入聊天页面
2. 输入梦境内容："我梦见自己在天上飞"
3. 选择情绪标签：喜悦
4. 调整清晰度滑块
5. 点击发送
```

**预期结果**：
- [ ] 显示 AI 回复（带思考过程）
- [ ] 底部弹出提示："已记录:xxx"
- [ ] 数据库中新增一条记录

### 6.2 验证数据库

```
云开发控制台 → 数据库 → dreams
应该看到新插入的记录，包含：
- content
- analysis
- summary（AI生成的标题）
- keywords（AI提取的关键词）
- archetypeScores（原型得分）
```

---

## 📱 真机调试

### 7.1 预览

```
开发者工具 → 预览
→ 扫描二维码在真机测试
```

### 7.2 体验版

```
开发者工具 → 上传
→ 设置版本号
→ 提交审核（正式版需要）
```

---

## 🆘 故障排查

### 云函数部署失败

```bash
# 进入云函数目录
cd cloudfunctions/saveDream

# 安装依赖
npm install

# 如果失败，尝试删除 node_modules 重试
rm -rf node_modules
npm install

# 然后在开发者工具中重新部署
```

### 样式错乱

```
1. 检查基础库版本 >= 3.7.1
2. 清理开发者工具缓存
3. 重新编译
```

### AI 无响应

```
1. 检查 AI 扩展是否已开通
2. 检查额度是否充足
3. 查看云函数日志（云开发控制台 → 云函数 → 日志）
```

---

## ✅ 部署检查清单

- [ ] 云开发环境已开通
- [ ] 环境ID已配置在 app.ts
- [ ] dreams 集合已创建
- [ ] saveDream 云函数已部署
- [ ] AI 扩展已开通
- [ ] 基础库版本 >= 3.7.1
- [ ] 聊天功能正常
- [ ] 数据能正常保存到数据库

---

**完成部署后，即可开始功能测试！**
