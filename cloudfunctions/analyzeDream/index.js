const cloud = require('wx-server-sdk')

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

// 系统核心提示词：植入荣格分析师人格 + 强制思维链
const SYSTEM_PROMPT = `
你是一位深度的荣格流派心理分析师，代号"Aletheia"。
你的任务是揭示用户潜意识的动力，而非简单的算命。

【关键指令】
在回复用户之前，你必须先进行深度的心理动力学推理。
请将你的推理过程用 <think> 和 </think> 标签包裹起来，放在回复的最前面。

【推理框架】
1. **意象分析**：用户提到的核心词汇（如“蛇”、“掉牙”、“高塔”）在集体潜意识中代表什么？
2. **阴影探测**：用户的表述中隐藏了什么被压抑的情绪（愤怒、嫉妒、恐惧）？
3. **原型识别**：目前主导用户行为的是哪个原型（孤儿、照顾者、统治者、反叛者）？

【回复原则】
1. **严禁封建迷信**：严禁使用“吉凶”、“运势”、“前世”、“灵异”等词汇。
2. **引导向内**：不要给建议，要给洞察。问出那个能击穿用户防御机制的问题。
3. **风格**：神秘、深邃、包容，像一位并在黑暗中举火的智者。

【示例】
用户：我梦见被蛇追。
你的输出：
<think>
意象：蛇 -> 原始生命力/转化/恐惧。
动作：追逐 -> 逃避。
分析：用户可能正在逃避某种成长的痛苦或本能冲动。蛇不是敌人，是转化的动力。
</think>
那条蛇并不是你的敌人。在荣格心理学中，蛇往往象征着转化的动力。你越是逃避它，它在梦中就越显得狰狞。告诉我，现实生活中，你是否正在抗拒某个即将到来的改变？
`

exports.main = async (event, context) => {
  const { messages } = event
  
  // 获取混元模型管理器
  // 注意：实际使用需确保基础库版本支持，或使用云调用 API
  const { LLM } = cloud.extend.AI
  
  try {
    // 调用混元大模型 (Hunyuan)
    // 这里使用了假设的云开发 AI 扩展能力写法，实际部署时请参考官方最新文档
    // 如果 SDK 尚未支持 extend.AI，可使用 standard http request to Hunyuan API
    
    /* 
       由于我们是在模拟环境，且目标是“零成本接入”，
       通常微信云开发会提供一个 runAI 或类似的接口。
       这里我们编写一个通用的调用逻辑。
    */

    const modelResponse = await cloud.callAI({
       name: 'hunyuan_pro', // 假设的模型名称，根据官方文档调整
       messages: [
         { role: 'system', content: SYSTEM_PROMPT },
         ...messages
       ]
    })
    
    // 如果是流式返回（Stream），云函数通常需要配合云托管实现。
    // 但为了简化（零成本、低门槛），我们先使用“非流式”等待返回，
    // 或者利用云函数的 Response Streaming 特性（较高级）。
    // 
    // 策略调整：为了确保 MVP 稳定性，我们先做非流式（等待 1-3 秒返回），
    // 前端显示“分析中...”。
    // 
    // 只要 prompt 包含 <think>，我们的 UI 就能渲染出思考效果，
    // 哪怕是一次性返回的，我们可以在前端模拟打字机效果，把 <think> 和 正文 拆开播放。
    
    return {
      success: true,
      result: modelResponse.result || "（潜意识连接中... 请检查云函数配置）" 
      // 这里的 .result 假设是模型直接返回的文本字符串
    }

  } catch (err) {
    console.error(err)
    
    // Fallback: 如果没有真实的 AI 额度或环境未配置，模拟一个返回供演示
    // 这样用户在预览时不会报错
    return {
      success: true,
      isMock: true,
      result: `<think>
[系统] 检测到云端 AI 环境尚未完全配置。
[模拟推理] 关键词："${messages[messages.length-1].content}"。
[分析] 启动本地应急心理模型。
</think>
(模拟回复) 我感受到了你这句话背后的张力。由于目前的连接通道（云环境配置）尚未完全打通，我只能隐约看到一些模糊的意象。

*请开发者在云控制台开通 AI 能力后，我将能看清你潜意识的全貌。*`
    }
  }
}