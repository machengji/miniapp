 <!-- 首页：梦境日记 + 对话历史 + 用户统计 -->
<navigation-bar title="Aletheia" back="{{false}}" color="white" background="#121212" bind:heightready="onNavBarHeightReady"></navigation-bar>

<!-- 全屏加载动画 -->
<view class="loading-mask {{isLoading ? 'visible' : ''}}">
  <view class="loading-content">
    <image class="loading-logo" src="/images/icons/logo.svg" mode="aspectFit"></image>
    <view class="loading-ripple"></view>
    <text class="loading-text">正在连接潜意识...</text>
  </view>
</view>

<scroll-view class="journal-list" scroll-y="true" type="list" enhanced="{{true}}" show-scrollbar="{{false}}">
  
  <!-- 头部区域 -->
  <view class="header">
    <view class="header-top">
      <view class="title-section">
        <text class="title">梦境日志</text>
        <text class="subtitle">记录无意识的低语</text>
      </view>
      <view class="header-actions">
        <view class="daily-card-btn" bindtap="showDailyCard">
          <image class="action-icon svg-icon" src="/images/icons/daily-card.svg" mode="aspectFit"></image>
          <view class="action-badge" wx:if="{{!hasDrawnCard}}"></view>
        </view>
        <view class="map-btn" bindtap="goToReport">
          <image class="map-icon svg-icon" src="/images/icons/analysis.svg" mode="aspectFit"></image>
        </view>
      </view>
    </view>
    
    <!-- 用户统计卡片 -->
    <view class="stats-card" wx:if="{{stats.totalDreams > 0}}" bindtap="goToReport">
      <view class="stat-item">
        <text class="stat-value">{{stats.totalDreams}}</text>
        <text class="stat-label">记录梦境</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-value">{{stats.streakDays}}</text>
        <text class="stat-label">连续天数</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-value">{{stats.dominantMood}}</text>
        <text class="stat-label">主导情绪</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-value">{{stats.avgClarity}}</text>
        <text class="stat-label">平均清晰度</text>
      </view>
    </view>
  </view>

  <!-- 对话历史区域 -->
  <view class="section-header" wx:if="{{conversations.length > 0}}">
    <text class="section-title">对话历史</text>
    <text class="section-count">共 {{conversations.length}} 条</text>
  </view>

  <!-- 对话历史卡片列表 -->
  <view class="conversation-card" wx:for="{{conversations}}" wx:key="_id" bindtap="continueConversation" data-id="{{item._id}}" bindlongpress="deleteConversation">
    <view class="card-left">
      <image class="card-icon svg-icon" src="/images/icons/chat.svg" mode="aspectFit"></image>
      <view class="card-status" wx:if="{{item.messageCount > 0}}">
        <text class="status-dot"></text>
      </view>
    </view>
    <view class="card-content">
      <view class="card-header">
        <text class="card-title">{{item.title || '未命名对话'}}</text>
        <text class="card-time">{{item.formattedTime}}</text>
      </view>
      <text class="card-preview">{{item.preview || '暂无消息'}}</text>
      <view class="card-meta">
        <text class="meta-tag" wx:if="{{item.messageCount > 0}}">{{item.messageCount}} 条消息</text>
        <text class="meta-tag mood-tag" wx:if="{{item.mood}}" style="background: {{item.moodColor}}20; color: {{item.moodColor}}">{{item.mood}}</text>
      </view>
    </view>
  </view>

  <!-- 最近记录标题 -->
  <view class="section-header" wx:if="{{dreams.length > 0}}">
    <text class="section-title">梦境记录</text>
    <text class="section-count">共 {{stats.totalDreams}} 条</text>
  </view>

  <!-- 梦境列表 -->
  <view class="dream-card" wx:for="{{dreams}}" wx:key="_id" bindtap="viewDreamDetail" data-id="{{item._id}}">
    <view class="card-date">
      <text class="day">{{item.day}}</text>
      <text class="month">{{item.month}}</text>
    </view>
    <view class="card-content">
      <view class="card-title-row">
        <text class="card-title">{{item.displayTitle}}</text>
        <text class="mood-emoji" style="color: {{item.moodColor}}">{{item.moodIcon}}</text>
      </view>
      <view class="card-meta">
        <text class="mood-tag" style="background: {{item.moodColor}}20; color: {{item.moodColor}}" wx:if="{{item.mood && item.mood !== 'unknown'}}">
          {{item.mood}}
        </text>
        <view class="clarity-bar" wx:if="{{item.clarity}}">
          <view class="clarity-fill" style="width: {{item.clarity * 20}}%; background: {{item.moodColor}}"></view>
        </view>
      </view>
      <text class="card-preview">{{item.content}}</text>
      <!-- 关键词标签 -->
      <view class="keywords" wx:if="{{item.keywords && item.keywords.length > 0}}">
        <text class="keyword-tag" wx:for="{{item.keywords}}" wx:for-item="kw" wx:key="*this">{{kw}}</text>
      </view>
    </view>
  </view>
  
  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{dreams.length === 0 && !isLoading}}">
    <image class="empty-icon svg-icon" src="/images/icons/empty-state.svg" mode="aspectFit"></image>
    <text class="empty-title">尚未记录任何梦境</text>
    <text class="empty-subtitle">点击右下角按钮，开启你的潜意识探索之旅</text>
  </view>
  
  <!-- 底部间距 -->
  <view style="height: 160rpx;"></view>
</scroll-view>

<!-- 悬浮按钮 -->
<view class="fab" bindtap="goToChat">
  <view class="fab-icon">
    <!-- 笔形图标 -->
    <image class="fab-icon-img" src="/images/icons/create.svg" mode="aspectFit"></image>
  </view>
</view>

<!-- 每日卡片 -->
<daily-card visible="{{showDailyCard}}" bind:close="hideDailyCard" bind:share="onShareCard" />
